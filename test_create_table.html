<html>
<head>
    <title>JSONRPC 2.0 example over WebSocket</title>
    <style type="text/css">
     .tableView { min-width: 500px; position: absolute; }
     .tableView THEAD { background-color: #ccc; }
     .tableView TBODY { background-color: #eee; }
    </style>
    <script src="jquery.2.1.3.min.js"></script>
    <script src="drag.js"></script>
    <script src="model.js"></script>
    <script src="table_view.js"></script>
    <script src="table_controller.js"></script>
    <script>
     document.addEventListener("DOMContentLoaded", function(event) {
         init();
     });
     function init() {
         var uri = "ws://localhost:7778";
         var socket = new WebSocket(uri);
         var uid = 1;
         var table_next_id = 1;

         /* handle_create_table */
         var model = new $.Model();
         var view = new $.TableView($("#parent"));
         var controller = new $.TableController(model, view);

         function send(msg) {
             socket.send(msg);
         }
             
         socket.onopen = function(event) {
             console.log("onopen: ");
         };

         function handle_create_table(request) {
             var r = request;
             if (r['method'] != 'create_table')
                 return false;

             /* model.append(r['params']); */
             view.setHeader(r['params'])
             var response = {
                 "jsonrpc": "2.0",
                 "id": r['id'],
                 "table_id": table_next_id++
             };
             var msg = JSON.stringify(response);
             console.log("handle_create_table: " + msg);
             send(msg);
             return true;
         }

         function handle_append_row(request) {
             var r = request;
             if (r['method'] != 'append_row')
                 return false;
             
             model.append(r['params']);
             var response = {
                 "jsonrpc": "2.0",
                 "id": r['id'],
                 "table_id": r['table_id'],
                 "length": model.length()
             };
             var msg = JSON.stringify(response);
             console.log("handle_append_row: " + msg);
             send(msg);
             return true;
         }

         socket.onmessage = function(event) {
             console.log("onmessage: " + event.data);
             request = JSON.parse(event.data);
             var handlers = new Array();
             handlers.push(handle_create_table,
                           handle_append_row);
             var handled = false;
             handlers.forEach(function(element, index, list) {
                 if (handled)
                     return;
                 handled = element(request);
             });
         };
     }
    </script>
</head>
<body>
    <div id="parent">
    </div>
</body>
</html>
