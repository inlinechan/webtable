<html>
<head>
    <title>JSONRPC 2.0 example over WebSocket</title>
    <style type="text/css">
     .tableView {
         min-width: 300px;
         height: 400px;
         padding: 0px;
         margin: 0px;
         border-collapse: collapse;
     }
     .tableView THEAD { background-color: #ccc; }
     .tableView TBODY { background-color: #eee; }
     .tableView TD, .tableView TH {
         border: 1px solid #555;
         padding: 5px;
     }
     .tableView TD {
         text-align: right;
     }
     #table_container {
         position: relative;
         top: 20px;
         float: left;
     }
     #plot_container {
         position: relative;
         top: 20px;
         float: right;
     }
     #plot_container .plot {
         width: 500px;;
         height: 400px;
         position: relative;
     }
     .FrameView {
         border: 1px solid black;
         position: relative;
     }
     .FrameView .title {
         padding-left: 10px;
         background-color: #aaa;
     }

     .FrameView .title_id {
         float: right;
     }

     #toolbar_container {
         position: absolute;
         top: 0px;
         right: 0px;
         width: 100%;
         background-color: #eee;
         border-bottom: 1px solid #aaa;
     }
     #login {
         float: right;
     }
     .connect {
         width: 20px;
         height: 20px;
         background: transparent url('images/connect.png') no-repeat center;
     }
     .disconnect {
         width: 20px;
         height: 20px;
         background: transparent url('images/disconnect.png') no-repeat center;
     }
    </style>
    <script src="jquery.2.1.3.min.js"></script>
    <script src="drag.js"></script>
    <script src="model.js"></script>
    <script src="table_view.js"></script>
    <script src="frame_view.js"></script>
    <!-- http://code.highcharts.com/highcharts.js -->
    <script src="highchart_view.js"></script>
    <script src="table_controller.js"></script>
    <script src="table.js"></script>
    <script src="highcharts.js"></script>
    <script>
     document.addEventListener("DOMContentLoaded", function(event) {
         var uri = $('#uri').prop('value');
         $('#connect').click(function() {
             init(uri);
         });
         init(uri);
     });
     function init(uri) {
         var default_uri = "ws://localhost:7778";
         try {
             var socket = new WebSocket(uri || default_uri);
         } catch (e) {
             console.log('failed to connect ' + uri);
             return;
         }

         var table_next_id = 1;
         var tables = {};

         function send(msg) {
             socket.send(msg);
         }
             
         socket.onopen = function(event) {
             console.log("onopen: ");
             $('#connect').prop('disabled', true);
             $('#uri').prop('disabled', true);
         };

         socket.onclose = function(event) {
             console.log("onclose: ");
             $('#connect').prop('disabled', false);
             $('#uri').prop('disabled', false);
         };

         function handle_create_table(request) {
             var r = request;
             if (r['method'] != 'create_table')
                 return false;

             var table_id = table_next_id++;
             var table = new $.Table(table_id, r['name']);
             table.setHeader(r['params'])
             tables[table_id] = table;
             console.log("table created: " + table_id);
             var response = {
                 "jsonrpc": "2.0",
                 "id": r['id'],
                 "table_id": table_id
             };
             var msg = JSON.stringify(response);
             console.log("handle_create_table: " + msg);
             send(msg);
             return true;
         }

         function handle_append_row(request) {
             var r = request;
             if (r['method'] != 'append_row')
                 return false;

             var table = tables[r['table_id']];
             table.append(r['params']);
             var response = {
                 "jsonrpc": "2.0",
                 "id": r['id'],
                 "table_id": r['table_id'],
                 "length": table.length()
             };
             var msg = JSON.stringify(response);
             console.log("handle_append_row: " + msg);
             send(msg);
             return true;
         }

         socket.onmessage = function(event) {
             console.log("onmessage: " + event.data);
             request = JSON.parse(event.data);
             var handlers = new Array();
             handlers.push(handle_create_table,
                           handle_append_row);
             var handled = false;
             handlers.forEach(function(element, index, list) {
                 if (handled)
                     return;
                 handled = element(request);
             });
         };
     }
    </script>
</head>
<body>
    <div id="toolbar_container">
        <div id="login">
            URL: <input id="uri" value="ws://localhost:7778"/>
            <button id="connect" name="connect" class="connect"></button>
        </div>
    </div>
    <div id="table_container"></div>
    <div id="plot_container"></div>
</body>
</html>
