<html>
<head>
    <title>WebTable v0.1</title>
    <link rel="stylesheet" type="text/css" href="webtable.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <!-- <script src="jquery.2.1.3.min.js"></script> -->
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="drag.js"></script>
    <script src="model.js"></script>
    <script src="table_view.js"></script>
    <script src="frame_view.js"></script>
    <!-- http://code.highcharts.com/highcharts.js -->
    <script src="highchart_view.js"></script>
    <script src="table_controller.js"></script>
    <script src="table.js"></script>
    <script src="highcharts.js"></script>
    <script src="exporting.js"></script>
    <script src="web_table.js"></script>
    <script>
     document.addEventListener("DOMContentLoaded", function(event) {
         var web_table = new $.WebTable();
         var collector = new Array();
         var button_listener = $.WebTableListener({
             onopen: function(event, socket) {
                 $('#connect').removeClass('connect').addClass('disconnect');
                 $('#uri').prop('disabled', true);
             },
             onclose: function(event, socket) {
                 $('#connect').removeClass('disconnect').addClass('connect');
                 $('#uri').prop('disabled', false);
             },
             onmessage: function(msg) {
                 collector.push(msg);
                 if (collector.length > 0)
                     $('#save').prop('disabled', false);
             }
         });

         var uri = $('#uri').prop('value');

         web_table.addListener(button_listener);
         web_table.connect(uri);

         $('#connect').click(function() {
             if ($('#connect').hasClass('connect'))
                 web_table.connect($('#uri').prop('value'));
             else
                 web_table.disconnect();
         });

         $('#save').click(function() {
             if (collector.length > 0) {
                 var data = "";
                 collector.forEach(function(e, i, ar) {
                     data += e + ',\n';
                 });
             }
             var MIME_TYPE = 'application/json';
             var bb = new Blob([data], {type: MIME_TYPE});
             var a = document.createElement('a');
             var date = new Date();
             a.id = 'download';
             var date_detail = date.toString().split(/[ \t]/).splice(0, 5).join('_').replace(/[ \t:]+/g, '_');
             a.download = 'webtable_' +  date_detail + '.txt';
             a.href = window.URL.createObjectURL(bb);
             a.textContent = 'Download ready';
             a.dataset.downloadurl = [MIME_TYPE, a.download, a.href].join(':');
             a.style.display = 'none';
             $('#session').append(a);

             var cleanUp = function(a) {
                 a.textContent = 'Downloaded';

                 // Need a small delay for the revokeObjectURL to work properly.
                 setTimeout(function() {
                     window.URL.revokeObjectURL(a.href);
                     $('#session a').remove();
                 }, 500);
             };

             a.onclick = function(e) {
                 cleanUp(this);
             };
             a.click();
         });
     });
    </script>
</head>
<body>
    <div id="toolbar_container">
        <span id="session">
            <input type="file" id="load" name="files" class="load" />
            <button id="save" name="save" class="save" disabled>Save</button>
        </span>
        |
        <span id="login">
            URL: <input id="uri" value="ws://localhost:7778"/>
            <button id="connect" name="connect" class="connect"></button>
        </span>
    </div>
    <div id="table_container"></div>
    <div id="plot_container"></div>
    <script>
     function handleLoad(evt) {
         $('.FrameView').remove();
         var file = evt.target.files[0];

         var reader = new FileReader();
         reader.onload = (function(theFile) {
             return function(e) {
                 var web_table = new $.WebTable();
                 var lines = e.target.result.split(',\n');
                 lines.forEach(function(elem, i, ar) {
                     if (elem.length > 0)
                         web_table.append(elem);
                 });
             };
         })(file);
         reader.readAsText(file);
     };
     document.getElementById('load').addEventListener('change', handleLoad, false);
    </script>
</body>
</html>
